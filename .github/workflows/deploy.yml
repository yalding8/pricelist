name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          # 进入项目目录
          cd /var/www/pricelist || exit 1

          # 备份当前版本
          if [ -d "releases/$(date +%Y%m%d_%H%M%S)" ]; then
            echo "Backup already exists"
          else
            mkdir -p releases
            cp -r current releases/$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
          fi

          # 拉取最新代码
          cd current
          git fetch origin
          git reset --hard origin/main

          # 激活虚拟环境
          source venv/bin/activate

          # 安装依赖
          pip install -r requirements.txt

          # 安装Playwright浏览器
          python -m playwright install chromium

          # 重启服务
          sudo systemctl restart pricelist

          # 检查服务状态
          sleep 2
          sudo systemctl status pricelist --no-pager

          # 清理旧备份（保留最近5个）
          cd /var/www/pricelist/releases
          ls -t | tail -n +6 | xargs -r rm -rf

          echo "✅ Deployment completed successfully!"
